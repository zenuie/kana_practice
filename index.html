<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ËÅΩÂØ´ÁâπË®ì</title>

    <!-- ‚òÖ Google Analytics (GA4) ‚òÖ -->
    <!-- Ë´ãÂ∞á G-PPXWYCEVKF ÊõøÊèõÁÇ∫‰Ω†ÁöÑ Measurement ID -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-2G0C5C0QBQ"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());

        gtag('config', 'G-2G0C5C0QBQ');
    </script>
    <!-- ‚òÖ GA ÁµêÊùü ‚òÖ -->

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>

    <style>
        body {
            font-family: "Noto Sans JP", "Hiragino Kaku Gothic ProN", sans-serif;
            background-color: #f4f7f6;
            touch-action: none;
            user-select: none;
            overflow: hidden;
        }

        #startOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.98);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        #saveModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #saveImageDisplay {
            background: black;
            border: 4px solid #fff;
            border-radius: 16px;
            width: 250px;
            height: 250px;
            object-fit: contain;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.2);
            image-rendering: pixelated;
        }

        .top-bar {
            background: white;
            padding: 10px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .learning-card {
            background: white;
            border-radius: 24px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            max-width: 400px;
            margin: 20px auto;
            position: relative;
        }

        .question-area {
            padding: 20px;
            text-align: center;
            background: #e3f2fd;
            position: relative;
        }

        .speaker-btn {
            width: 90px;
            height: 90px;
            background: #2196f3;
            border-radius: 50%;
            color: white;
            font-size: 40px;
            border: none;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
            transition: transform 0.1s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .speaker-btn:active {
            transform: scale(0.95);
        }

        .hint-text {
            font-size: 6rem;
            font-weight: bold;
            color: #1565c0;
            display: none;
            animation: fadeIn 0.3s;
        }

        .romaji-hint {
            font-size: 1.2rem;
            color: #666;
            margin-top: 10px;
            display: none;
        }

        .canvas-container {
            position: relative;
            width: 100%;
            aspect-ratio: 1 / 1;
            background: #fff;
            cursor: crosshair;
            border-top: 2px dashed #e0e0e0;
            border-bottom: 2px dashed #e0e0e0;
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .controls {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-action {
            padding: 15px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            transition: all 0.2s;
        }

        .btn-check {
            background: #4caf50;
            color: white;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .btn-check:active {
            transform: translateY(2px);
        }

        .tools-row {
            display: flex;
            gap: 10px;
        }

        .btn-tool {
            flex: 1;
            background: #f5f5f5;
            color: #555;
        }

        .feedback-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            z-index: 10;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            animation: slideUp 0.3s ease-out;
        }

        .result-icon {
            font-size: 80px;
            margin-bottom: 10px;
        }

        .result-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .result-desc {
            color: #666;
            margin-bottom: 20px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>

<div id="startOverlay">
    <div class="mb-4" style="font-size: 3rem;">üéå</div>
    <h1 class="mb-4 text-primary fw-bold">ËÅΩÂØ´ÁâπË®ì</h1>
    <div class="px-4">
        <p class="text-muted mb-4">Ë´ãÈñãÂïüÈü≥ÈáèÔºåÈªûÊìä‰∏ãÊñπÊåâÈàïÈñãÂßã</p>
        <button class="btn btn-primary btn-lg px-5 py-3 rounded-pill shadow fw-bold" onclick="app.unlockAudio()">
            ‚ñ∂Ô∏è ÈñãÂßãÁ∑¥Áøí
        </button>
    </div>
</div>

<div id="saveModal" onclick="this.style.display='none'">
    <h3 class="text-white mb-3">Èï∑ÊåâÂúñÁâáÂä†ÂÖ•ÁÖßÁâá</h3>
    <img id="saveImageDisplay" src="" alt="Sample">
    <p class="text-white-50 mt-3 small">Â∑≤ËΩâÁÇ∫ÈªëÂ∫ïÁôΩÂ≠óÊ≠£ÊñπÂΩ¢Ê†ºÂºè</p>
</div>

<div class="top-bar">
    <div class="fw-bold text-primary">üéå ËÅΩÂØ´ÁâπË®ì</div>
    <div class="d-flex gap-2 align-items-center">
        <span id="statusBadge" class="badge bg-secondary">ËºâÂÖ• AI...</span>
        <span class="badge bg-light text-dark border">ÈÄ£Â∞ç: <span id="streakCount">0</span></span>
    </div>
</div>

<div class="learning-card">
    <div class="question-area">
        <button class="speaker-btn" id="btnPlay" onclick="app.playAudio()">üîä</button>
        <div id="visualHint" class="hint-text">„ÅÇ</div>
        <div id="romajiHint" class="romaji-hint">a</div>
        <div class="mt-3">
            <button class="btn btn-sm btn-link text-decoration-none" onclick="app.toggleHint()">üí° ÂÅ∑ÁúãÊèêÁ§∫</button>
        </div>
    </div>

    <div class="canvas-container">
        <div class="grid-line grid-h"></div>
        <div class="grid-line grid-v"></div>
        <canvas id="drawingBoard"></canvas>
    </div>

    <div class="controls">
        <button class="btn-action btn-check" onclick="app.checkAnswer()">‚ú® Ê™¢Êü•Á≠îÊ°à</button>
        <div class="tools-row">
            <button class="btn-action btn-tool" onclick="sketch.clear()">üóëÔ∏è Ê∏ÖÈô§</button>
            <button class="btn-action btn-tool" onclick="app.nextQuestion()">‚è© Ë∑≥ÈÅé</button>
        </div>
    </div>

    <div id="feedbackOverlay" class="feedback-overlay">
        <div id="fbIcon" class="result-icon">üéâ</div>
        <div id="fbTitle" class="result-title">Á≠îÂ∞ç‰∫ÜÔºÅ</div>
        <div id="fbDesc" class="result-desc">AI ÁúãÂà∞Ôºö„ÅÇ (99%)</div>

        <div class="d-grid gap-2 w-75">
            <button class="btn btn-primary btn-lg rounded-pill shadow" onclick="app.nextQuestion()">‰∏ã‰∏ÄÈ°å ‚ûî</button>
            <div class="border-top pt-3 mt-2">
                <small class="text-muted d-block mb-2">AI Âà§Êñ∑ÈåØ‰∫ÜÂóéÔºü</small>
                <button class="btn btn-outline-danger btn-sm w-100" onclick="app.markAsWrong()">‚ùå ÂÖ∂ÂØ¶ÊàëÂØ´ÈåØ‰∫Ü</button>
                <button class="btn btn-outline-success btn-sm w-100 mt-2" onclick="app.forceCorrect()">‚≠ï ÂÖ∂ÂØ¶ÊàëÊòØÂ∞çÁöÑ (Â≠òÂúñ)</button>
            </div>
        </div>
    </div>
</div>

  <script>
    // ‰ΩøÁî®‰Ω†Êèê‰æõÁöÑ KANA_DB
    const KANA_DB = [
      {r: 'a', h: '„ÅÇ'}, {r: 'i', h: '„ÅÑ'}, {r: 'u', h: '„ÅÜ'}, {r: 'e', h: '„Åà'}, {r: 'o', h: '„Åä'},
      {r: 'ka', h: '„Åã'}, {r: 'ki', h: '„Åç'}, {r: 'ku', h: '„Åè'}, {r: 'ke', h: '„Åë'}, {r: 'ko', h: '„Åì'},
      {r: 'sa', h: '„Åï'}, {r: 'shi', h: '„Åó'}, {r: 'su', h: '„Åô'}, {r: 'se', h: '„Åõ'}, {r: 'so', h: '„Åù'},
      {r: 'ta', h: '„Åü'}, {r: 'chi', h: '„Å°'}, {r: 'tsu', h: '„Å§'}, {r: 'te', h: '„Å¶'}, {r: 'to', h: '„Å®'},
      {r: 'na', h: '„Å™'}, {r: 'ni', h: '„Å´'}, {r: 'nu', h: '„Å¨'}, {r: 'ne', h: '„Å≠'}, {r: 'no', h: '„ÅÆ'},
      {r: 'ha', h: '„ÅØ'}, {r: 'hi', h: '„Å≤'}, {r: 'fu', h: '„Åµ'}, {r: 'he', h: '„Å∏'}, {r: 'ho', h: '„Åª'},
      {r: 'ma', h: '„Åæ'}, {r: 'mi', h: '„Åø'}, {r: 'mu', h: '„ÇÄ'}, {r: 'me', h: '„ÇÅ'}, {r: 'mo', h: '„ÇÇ'},
      {r: 'ya', h: '„ÇÑ'}, {r: 'yu', h: '„ÇÜ'}, {r: 'yo', h: '„Çà'},
      {r: 'ra', h: '„Çâ'}, {r: 'ri', h: '„Çä'}, {r: 'ru', h: '„Çã'}, {r: 're', h: '„Çå'}, {r: 'ro', h: '„Çç'},
      {r: 'wa', h: '„Çè'}, {r: 'wo', h: '„Çí'}, {r: 'n', h: '„Çì'}
    ];

    let MODEL_LABELS = [];

    const app = {
      session: null,
      currentQ: null,
      streak: 0,
      autoCheckTimer: null,
      isAudioUnlocked: false,

      init: async function () {
        sketch.init();
        if ('speechSynthesis' in window) window.speechSynthesis.getVoices();
        await this.loadLabels();
        await this.initAI();

        document.getElementById('btnStart').addEventListener('click', () => this.unlockAudio());
        document.getElementById('btnPlay').addEventListener('click', () => this.playAudio());
        document.getElementById('btnHint').addEventListener('click', () => this.toggleHint());
        document.getElementById('btnClear').addEventListener('click', () => sketch.clear());
        document.getElementById('btnSave').addEventListener('click', () => this.handleSaveAction());
        document.getElementById('btnNext').addEventListener('click', () => this.nextQuestion());
        document.getElementById('btnForce').addEventListener('click', () => this.forceCorrect());
        document.getElementById('btnWrong').addEventListener('click', () => this.markAsWrong());
        document.getElementById('btnCloseSave').addEventListener('click', () => {
          document.getElementById('saveModal').style.display = 'none';
        });
      },

      loadLabels: async function () {
        try {
          const res = await fetch('./data/labels.json');
          if (res.ok) MODEL_LABELS = await res.json();
        } catch (e) {
          console.warn("Labels error", e);
        }
      },

      initAI: async function () {
        try {
          const option = { executionProviders: ['wasm'] };
          this.session = await ort.InferenceSession.create('./onnx_model/hiragana.onnx', option);
          document.getElementById('statusBadge').className = 'badge bg-success';
          document.getElementById('statusBadge').innerText = 'AI Â∞±Á∑í';
        } catch (e) {
          document.getElementById('statusBadge').className = 'badge bg-danger';
          document.getElementById('statusBadge').innerText = 'AI Â§±Êïó';
        }
      },

      unlockAudio: function () {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (AudioContext) {
          const ctx = new AudioContext();
          const osc = ctx.createOscillator();
          osc.connect(ctx.destination);
          osc.start(0);
          osc.stop(0.01);
        }
        if ('speechSynthesis' in window) {
          window.speechSynthesis.cancel();
          const u = new SpeechSynthesisUtterance('');
          window.speechSynthesis.speak(u);
        }
        this.isAudioUnlocked = true;

        document.getElementById('startOverlay').style.display = 'none';
        this.nextQuestion();
      },

      nextQuestion: function () {
        document.getElementById('feedbackOverlay').style.display = 'none';
        this.currentQ = KANA_DB[Math.floor(Math.random() * KANA_DB.length)];
        const v = document.getElementById('visualHint');
        const r = document.getElementById('romajiHint');
        v.style.display = 'none';
        v.innerText = this.currentQ.h;
        r.style.display = 'none';
        r.innerText = this.currentQ.r;
        document.getElementById('btnPlay').style.display = 'inline-flex';
        sketch.clear();
        if (this.isAudioUnlocked) setTimeout(() => this.playAudio(), 500);
      },

      // ÊîπÁÇ∫ËÆÄÂèñÊú¨Ê©ü /pronunce/{romaji}.mp3
      playAudio: async function () {
        if (!this.currentQ) return;
        const romaji = this.currentQ.r;
        const audioUrl = `/pronunce/${romaji}.mp3`;

        const loadingEl = document.getElementById('audioLoading');
        if (loadingEl) loadingEl.style.display = 'block';

        try {
          const audio = new Audio(audioUrl);
          // Êüê‰∫õÁÄèË¶ΩÂô®ÈúÄË¶ÅÁî®‰∫ã‰ª∂Á¢∫‰øùËÉΩÊí≠Êîæ
          await audio.play();
        } catch (e) {
          console.warn('Êú¨Ê©ü mp3 Êí≠ÊîæÂ§±ÊïóÔºåÊîπÁî®ÂÇôÊè¥Ë™ûÈü≥Ôºö', e);
          this.playFallbackAudio(this.currentQ.h);
        } finally {
          if (loadingEl) loadingEl.style.display = 'none';
        }
      },

      playFallbackAudio: function (text) {
        if (!('speechSynthesis' in window)) return;
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'ja-JP';
        u.rate = 0.8;
        const voices = window.speechSynthesis.getVoices();
        const preferredVoice = voices.find(v => v.lang === 'ja-JP' && (v.name.includes("Kyoko") || v.name.includes("Otoya")));
        if (preferredVoice) u.voice = preferredVoice;
        window.speechSynthesis.speak(u);
        if (window.speechSynthesis.paused) window.speechSynthesis.resume();
      },

      toggleHint: function () {
        const h = document.getElementById('visualHint');
        const r = document.getElementById('romajiHint');
        const btn = document.getElementById('btnPlay');
        const isHidden = h.style.display === 'none';
        h.style.display = isHidden ? 'block' : 'none';
        r.style.display = isHidden ? 'block' : 'none';
        btn.style.display = isHidden ? 'none' : 'inline-flex';
      },

      startAutoCheck: function () {
        if (this.autoCheckTimer) clearTimeout(this.autoCheckTimer);
        this.autoCheckTimer = setTimeout(() => {
          if (document.getElementById('feedbackOverlay').style.display === 'none') {
            this.checkAnswer();
          }
        }, 1200);
      },

      cancelAutoCheck: function () {
        if (this.autoCheckTimer) {
          clearTimeout(this.autoCheckTimer);
          this.autoCheckTimer = null;
        }
      },

      checkAnswer: async function () {
        if (!this.session || sketch.isEmpty()) return;
        const canvas = document.getElementById('drawingBoard');
        const inputTensor = this.processCanvasForONNX(canvas);
        if (!inputTensor) return;

        try {
          const feeds = { input: inputTensor };
          const results = await this.session.run(feeds);
          const outputData = results.output.data;
          let maxVal = -Infinity, maxIdx = -1;
          for (let i = 0; i < outputData.length; i++) {
            if (outputData[i] > maxVal) {
              maxVal = outputData[i];
              maxIdx = i;
            }
          }
          const aiChar = MODEL_LABELS[maxIdx];
          const mapFix = {"ta": "„Åü", "te": "„Å¶", "ha": "„ÅØ", "he": "„Å∏", "ho": "„Åª"};
          const displayChar = mapFix[aiChar] || aiChar;
          this.showFeedback(displayChar, maxVal);
        } catch (e) {
          console.error(e);
        }
      },

      showFeedback: function (aiChar, confidence) {
        const overlay = document.getElementById('feedbackOverlay');
        const icon = document.getElementById('fbIcon');
        const title = document.getElementById('fbTitle');
        const desc = document.getElementById('fbDesc');
        overlay.style.display = 'flex';

        if (aiChar === this.currentQ.h) {
          icon.innerText = 'üéâ';
          title.innerText = 'Á≠îÂ∞ç‰∫ÜÔºÅ';
          title.style.color = '#2e7d32';
          desc.innerText = `AI ÁúãÂà∞Ôºö${aiChar} (${confidence.toFixed(1)})`;
          this.streak++;
          setTimeout(() => this.playAudio(), 200);
        } else {
          icon.innerText = 'ü§î';
          title.innerText = 'ÂóØ...‰∏çÂ§™ÂÉèÔºü';
          title.style.color = '#c62828';
          desc.innerText = `È°åÁõÆÊòØ„Äå${this.currentQ.h}„ÄçÔºåAI ÁúãÂà∞„Äå${aiChar}„Äç`;
          this.streak = 0;
        }
        document.getElementById('streakCount').innerText = this.streak;
      },

      forceCorrect: function () {
        this.handleSaveAction();
        this.streak++;
        document.getElementById('streakCount').innerText = this.streak;
        document.getElementById('fbTitle').innerText = "Â∑≤ÂõûÂ†±ÔºÅ";
        setTimeout(() => this.nextQuestion(), 1500);
      },

      markAsWrong: function () {
        this.streak = 0;
        document.getElementById('streakCount').innerText = 0;
        this.nextQuestion();
      },

      handleSaveAction: function () {
        const canvas = document.getElementById('drawingBoard');
        const readableImage = createBlackBgImage(canvas, 300);
        if (!readableImage) return;

        const dataUrl = readableImage.toDataURL("image/png");
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        if (isMobile) {
          const modal = document.getElementById('saveModal');
          const img = document.getElementById('saveImageDisplay');
          img.src = dataUrl;
          modal.style.display = 'flex';
        } else {
          const link = document.createElement('a');
          link.download = `${this.currentQ.r}_${Date.now()}.png`;
          link.href = dataUrl;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      },

      processCanvasForONNX: function (sourceCanvas) {
        const processedCanvas = createBlackBgImage(sourceCanvas, 64);
        if (!processedCanvas) return null;
        const ctx = processedCanvas.getContext('2d');
        const imgData = ctx.getImageData(0, 0, 64, 64);
        const { data } = imgData;
        const floatData = new Float32Array(3 * 64 * 64);
        for (let i = 0; i < 64 * 64; i++) {
          const r = data[i * 4] / 255.0;
          floatData[i] = r;
          floatData[64 * 64 + i] = r;
          floatData[2 * 64 * 64 + i] = r;
        }
        return new ort.Tensor('float32', floatData, [1, 3, 64, 64]);
      }
    };

    function createBlackBgImage(sourceCanvas, targetSize = 300) {
      const ctx = sourceCanvas.getContext('2d');
      const width = sourceCanvas.width;
      const height = sourceCanvas.height;
      const imgData = ctx.getImageData(0, 0, width, height);
      const data = imgData.data;

      let minX = width, minY = height, maxX = 0, maxY = 0, found = false;
      for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
          if (data[(y * width + x) * 4] < 200) {
            if (x < minX) minX = x;
            if (x > maxX) maxX = x;
            if (y < minY) minY = y;
            if (y > maxY) maxY = y;
            found = true;
          }
        }
      }
      if (!found) return null;

      const cropW = maxX - minX + 1;
      const cropH = maxY - minY + 1;
      const padding = Math.floor(targetSize * 0.1);

      const scale = Math.min((targetSize - padding * 2) / cropW, (targetSize - padding * 2) / cropH);
      const sw = Math.floor(cropW * scale);
      const sh = Math.floor(cropH * scale);
      const dx = Math.floor((targetSize - sw) / 2);
      const dy = Math.floor((targetSize - sh) / 2);

      const finalC = document.createElement('canvas');
      finalC.width = targetSize;
      finalC.height = targetSize;
      const fCtx = finalC.getContext('2d');

      fCtx.fillStyle = "black";
      fCtx.fillRect(0, 0, targetSize, targetSize);

      const tempC = document.createElement('canvas');
      tempC.width = targetSize;
      tempC.height = targetSize;
      const tCtx = tempC.getContext('2d');

      tCtx.fillStyle = "white";
      tCtx.fillRect(0, 0, targetSize, targetSize);
      tCtx.drawImage(sourceCanvas, minX, minY, cropW, cropH, dx, dy, sw, sh);

      const tData = tCtx.getImageData(0, 0, targetSize, targetSize);
      const pixels = tData.data;

      for (let i = 0; i < pixels.length; i += 4) {
        const val = pixels[i];
        const newVal = val > 128 ? 0 : 255;
        pixels[i] = newVal;
        pixels[i + 1] = newVal;
        pixels[i + 2] = newVal;
        pixels[i + 3] = 255;
      }

      fCtx.putImageData(tData, 0, 0);
      return finalC;
    }

    const sketch = {
      init: function () {
        this.c = document.getElementById('drawingBoard');
        this.ctx = this.c.getContext('2d', { willReadFrequently: true });
        const wrapper = this.c.parentElement;
        this.c.width = wrapper.clientWidth;
        this.c.height = wrapper.clientWidth;
        this.clear();

        const start = (e) => {
          if (e.target.tagName === 'BUTTON') return;
          e.preventDefault();
          this.draw = true;
          this.ctx.beginPath();
          const p = this.pos(e);
          this.ctx.moveTo(p.x, p.y);
          app.cancelAutoCheck();
        };
        const move = (e) => {
          if (e.target.tagName === 'BUTTON') return;
          e.preventDefault();
          if (this.draw) {
            const p = this.pos(e);
            this.ctx.lineTo(p.x, p.y);
            this.ctx.stroke();
          }
        };
        const end = () => {
          this.draw = false;
          app.startAutoCheck();
        };
        this.c.addEventListener('mousedown', start);
        this.c.addEventListener('mousemove', move);
        this.c.addEventListener('mouseup', end);
        this.c.addEventListener('touchstart', start, { passive: false });
        this.c.addEventListener('touchmove', move, { passive: false });
        this.c.addEventListener('touchend', end);

        window.addEventListener('resize', () => {
          this.c.width = wrapper.clientWidth;
          this.c.height = wrapper.clientWidth;
          this.clear();
        });
      },
      pos: function (e) {
        const r = this.c.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const scaleX = this.c.width / r.width;
        const scaleY = this.c.height / r.height;
        return {
          x: (clientX - r.left) * scaleX,
          y: (clientY - r.top) * scaleY
        };
      },
      clear: function () {
        this.ctx.fillStyle = "white";
        this.ctx.fillRect(0, 0, this.c.width, this.c.height);
        this.ctx.lineWidth = 15;
        this.ctx.lineCap = 'round';
        this.ctx.lineJoin = 'round';
        this.ctx.strokeStyle = 'black';
        app.cancelAutoCheck();
      },
      isEmpty: function () {
        const d = this.ctx.getImageData(0, 0, this.c.width, this.c.height).data;
        for (let i = 0; i < d.length; i += 4) if (d[i] < 255) return false;
        return true;
      }
    };

    document.addEventListener("DOMContentLoaded", () => app.init());
  </script>
</body>
</html>